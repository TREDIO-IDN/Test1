<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TREDIO â€” Grafik Terhubung harga.html (Full)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{ --bg:#0b0b0c; --panel:#111217; --muted:#9aa0a6; --green:#2ecc71; --red:#e74c3c; --accent:#f1c40f; }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
  .app{ max-width:1100px;margin:16px auto;padding:12px; display:grid;grid-template-columns:1fr 320px;gap:16px; }
  @media (max-width:960px){ .app{ grid-template-columns:1fr; padding:10px } }
  .panel{ background:linear-gradient(180deg,#070708 0%, var(--panel) 100%); border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6); }
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  .small-muted{ color:#9aa0a6; font-size:13px }
  .chart-wrap{ position:relative; background:#000;border-radius:10px;padding:10px; }
  #mainChart{ width:100% !important; height:380px !important; display:block; border-radius:8px; }
  .right-panel{ display:flex;flex-direction:column;gap:12px }
  .card{ background:#0f1113;padding:12px;border-radius:10px; }
  .sparkline{ width:100%; height:120px; }
  .timeline{ display:flex; gap:8px; overflow-x:auto; padding:8px; }
  .time-item{ min-width:86px; background:#0b0b0b; padding:8px; border-radius:8px; text-align:center; cursor:pointer; border:1px solid #1a1a1a }
  .time-item.active{ outline:2px solid rgba(46,204,113,0.18); }
  .controls{ display:flex; gap:8px; align-items:center; }
  button{ background:linear-gradient(135deg,#2ecc71,#27ae60); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer }
  .muted{ color:#9aa0a6 }
  .clockNow{ text-align:center; margin-top:8px; font-weight:700 }
</style>
</head>
<body>

<div class="app">
  <div class="panel">
    <div class="header">
      <div>
        <div style="font-size:15px;color:#ddd">ðŸ“ˆ Grafik Harga â€” Terhubung ke harga.html</div>
        <div class="small-muted">Menampilkan 5 menit terakhir â€” geser ke kiri untuk lihat sebelumnya</div>
      </div>
      <div style="text-align:right">
        <div class="small-muted">Sumber data</div>
        <div style="font-weight:700;color:#fff">harga.html</div>
      </div>
    </div>

    <div class="chart-wrap">
      <canvas id="mainChart"></canvas>
      <div class="clockNow" id="clockNow">--:--:--</div>
      <div style="margin-top:10px">
        <div class="timeline" id="timeline"></div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Sparkline Hari Ini</div>
          <div style="font-weight:700">Ringkasan Harga</div>
        </div>
        <div>
          <div style="font-size:12px;color:#9aa0a6">Auto-refresh</div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="autoRefresh" checked />
            <small class="muted">on</small>
          </label>
        </div>
      </div>
      <canvas id="sparkline" class="sparkline"></canvas>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btnReload">Reload Data</button>
        <button id="btnCenter">Center Now</button>
      </div>
      <div style="margin-top:10px" class="small-muted">Klik item timeline untuk memilih waktu sebagai referensi.</div>
    </div>

    <div class="card">
      <div class="muted">Detail Terpilih</div>
      <div style="font-size:18px;font-weight:700;margin-top:6px" id="detailTime">--:--:--</div>
      <div style="font-size:16px;margin-top:6px" id="detailPrice">Rp --</div>
    </div>
  </div>
</div>

<script>
// URL relatif ke repo â€” pada GitHub Pages ini menjadi /Test1/harga.html jika berada di root repository
const DATA_URL = 'harga.html'; // pastikan harga.html ada di lokasi yang sama dengan index.html
let hargaData = []; // array of {waktu: 'HH:MM:SS', harga: number}

async function fetchHarga(){
  const res = await fetch(DATA_URL);
  const text = await res.text();
  const parser = new DOMParser();
  const doc = parser.parseFromString(text, 'text/html');
  const rows = [...doc.querySelectorAll('#hargaTable tr')].slice(1);
  hargaData = rows.map(r=>{
    const waktu = r.cells[0].innerText.trim();
    // handle input or plain text
    const input = r.cells[1].querySelector('input');
    const hargaStr = input ? input.value : r.cells[1].innerText.trim();
    const harga = Number(hargaStr.replace(/[^0-9\.-]/g,'')) || 0;
    return {waktu, harga};
  });
}

// helpers
function parseHHMMSS(s){ const [h,m,ss]=s.split(':').map(Number); return {h,m,ss}; }
function formatIDR(v){ return 'Rp '+Number(v).toLocaleString('id-ID'); }

// build sparkline (full day)
let sparkChart=null, mainChart=null;
async function buildCharts(){
  const sparkCtx = document.getElementById('sparkline').getContext('2d');
  const labels = hargaData.map(d=>d.waktu);
  const values = hargaData.map(d=>d.harga);
  if(sparkChart) sparkChart.destroy();
  sparkChart = new Chart(sparkCtx,{
    type:'line', data:{ labels, datasets:[{data:values, borderColor:'#f1c40f', pointRadius:0, borderWidth:1}] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{tension:0.2}} }
  });
}

// build main chart (per-second interpolation over visible window)
let mainData = {labels:[], values:[]};
function createMainChart(){
  const ctx = document.getElementById('mainChart').getContext('2d');
  if(mainChart) mainChart.destroy();
  mainChart = new Chart(ctx,{ type:'line', data:{ labels: mainData.labels, datasets:[{ label:'Harga (sim)', data: mainData.values, borderColor:'#2ecc71', backgroundColor:'rgba(46,204,113,0.06)', pointRadius:0, borderWidth:2 }] }, options:{ animation:false, responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ ticks:{display:false}, grid:{color:'#111'} }, y:{ ticks:{color:'#9aa0a6'}, grid:{color:'#111'} } } } });
}

// get index in hargaData for a given minute HH:MM
function findIndexByTime(hhmm){
  return hargaData.findIndex(d=>d.waktu.startsWith(hhmm));
}

// prepare visible window: last N minutes ending at nowIndex (minute)
function getWindowMinutes(centerIndex, windowSize){
  const out = [];
  for(let i=centerIndex-windowSize+1;i<=centerIndex;i++){
    if(i>=0 && i<hargaData.length) out.push({i, ...hargaData[i]});
  }
  return out;
}

// interpolate per-second data between minute points
function buildPerSecondSeries(centerIndex, minutesCount){
  // we will create seconds = minutesCount * 60 points, spanning from (centerIndex-minutesCount+1) minute start to center minute end
  const startIdx = Math.max(0, centerIndex - minutesCount + 1);
  const endIdx = centerIndex;
  const points = [];
  const labels = [];
  for(let idx=startIdx; idx<=endIdx; idx++){
    const current = hargaData[idx];
    const next = hargaData[idx+1] || current;
    const curPrice = current.harga;
    const nextPrice = next.harga;
    for(let s=0;s<60;s++){
      const t = s/60;
      // linear interpolation + tiny noise
      const interp = curPrice + (nextPrice - curPrice)*t + (Math.random()-0.5)*0.002;
      points.push(+interp.toFixed(3));
      labels.push(current.waktu.replace(':00','') + ':' + String(s).padStart(2,'0'));
    }
  }
  return {labels, points};
}

// render timeline items (scrollable minutes)
function renderTimeline(centerIndex, windowSize){
  const timeline = document.getElementById('timeline');
  timeline.innerHTML = '';
  const start = Math.max(0, centerIndex - 60); // show up to last 60 minutes by default in timeline (scrollable)
  for(let i=start;i<=centerIndex;i++){
    const item = document.createElement('div');
    item.className = 'time-item';
    item.dataset.index = i;
    item.innerHTML = `<div style="font-size:13px">${hargaData[i].waktu.slice(0,5)}</div><div style="font-weight:700;margin-top:6px">${formatIDR(hargaData[i].harga)}</div>`;
    item.addEventListener('click', ()=>{
      document.querySelectorAll('.time-item').forEach(el=>el.classList.remove('active'));
      item.classList.add('active');
      // set detail
      document.getElementById('detailTime').textContent = hargaData[i].waktu;
      document.getElementById('detailPrice').textContent = formatIDR(hargaData[i].harga);
      // rebuild main chart centered on this index
      updateMainCentered(i);
    });
    timeline.appendChild(item);
  }
}

function updateMainCentered(centerIndex){
  const windowSize = 5; // minutes
  const secSeries = buildPerSecondSeries(centerIndex, windowSize);
  mainData.labels = secSeries.labels;
  mainData.values = secSeries.points;
  createMainChart();
}

// clock
function startClock(){
  const el = document.getElementById('clockNow');
  setInterval(()=>{
    const now = new Date();
    el.textContent = now.toLocaleTimeString('it-IT');
  },1000);
}

// initialize everything
async function init(){
  await fetchHarga();
  if(!hargaData.length){ alert('Data harga kosong â€” pastikan harga.html tersedia dan memiliki tabel #hargaTable'); return; }
  await buildCharts();
  // center on current minute index
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const hhmm = `${hh}:${mm}`;
  // find index where waktu starts with hh:mm
  let centerIndex = hargaData.findIndex(d=>d.waktu.startsWith(hhmm));
  if(centerIndex === -1) centerIndex = Math.max(0, hargaData.length-1);

  renderTimeline(centerIndex, 60);
  updateMainCentered(centerIndex);
  // set default detail
  document.getElementById('detailTime').textContent = hargaData[centerIndex].waktu;
  document.getElementById('detailPrice').textContent = formatIDR(hargaData[centerIndex].harga);
  startClock();

  // auto-refresh data
  const autoCheckbox = document.getElementById('autoRefresh');
  document.getElementById('btnReload').addEventListener('click', async()=>{ await reloadDataAndRefresh(centerIndex); });
  document.getElementById('btnCenter').addEventListener('click', async()=>{ centerIndex = hargaData.findIndex(d=>d.waktu.startsWith(new Date().toLocaleTimeString('it-IT').slice(0,5))); if(centerIndex===-1) centerIndex = hargaData.length-1; renderTimeline(centerIndex,60); updateMainCentered(centerIndex); });

  setInterval(async()=>{
    if(autoCheckbox.checked){
      const prevLen = hargaData.length;
      await fetchHarga();
      if(hargaData.length !== prevLen) await buildCharts();
      // refresh centered at latest
      const newCenter = hargaData.findIndex(d=>d.waktu.startsWith(new Date().toLocaleTimeString('it-IT').slice(0,5)));
      const idx = newCenter===-1?hargaData.length-1:newCenter;
      renderTimeline(idx,60);
      updateMainCentered(idx);
      document.getElementById('detailTime').textContent = hargaData[idx].waktu;
      document.getElementById('detailPrice').textContent = formatIDR(hargaData[idx].harga);
    }
  }, 30*1000); // refresh every 30s if enabled
}

// reload helper
async function reloadDataAndRefresh(centerIndex){
  await fetchHarga();
  await buildCharts();
  renderTimeline(centerIndex,60);
  updateMainCentered(centerIndex);
}

// kick off
init();
</script>
</body>
</html>
