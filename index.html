<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TREDIO â€” Grafik Terhubung harga.html (Full, B)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{ --bg:#0b0b0c; --panel:#111217; --muted:#9aa0a6; --green:#2ecc71; --red:#e74c3c; --accent:#f1c40f; }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
  .app{ max-width:1100px;margin:16px auto;padding:12px; display:grid;grid-template-columns:1fr 320px;gap:16px; }
  @media (max-width:960px){ .app{ grid-template-columns:1fr; padding:10px } }
  .panel{ background:linear-gradient(180deg,#070708 0%, var(--panel) 100%); border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6); }
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  .small-muted{ color:#9aa0a6; font-size:13px }
  .chart-wrap{ position:relative; background:#000;border-radius:10px;padding:10px; }
  #mainChart{ width:100% !important; height:380px !important; display:block; border-radius:8px; }
  .right-panel{ display:flex;flex-direction:column;gap:12px }
  .card{ background:#0f1113;padding:12px;border-radius:10px; }
  .sparkline{ width:100%; height:120px; }
  .timeline{ display:flex; gap:8px; overflow-x:auto; padding:8px; }
  .time-item{ min-width:86px; background:#0b0b0b; padding:8px; border-radius:8px; text-align:center; cursor:pointer; border:1px solid #1a1a1a }
  .time-item.active{ outline:2px solid rgba(46,204,113,0.18); }
  .controls{ display:flex; gap:8px; align-items:center; }
  button{ background:linear-gradient(135deg,#2ecc71,#27ae60); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer }
  .muted{ color:#9aa0a6 }
  .clockNowTop{ text-align:center; margin-bottom:8px; font-weight:700 }
  .clockNowBottom{ text-align:center; margin-top:8px; font-weight:700 }
</style>
</head>
<body>

<div class="app">
  <div class="panel">
    <div class="header">
      <div>
        <div style="font-size:15px;color:#ddd">ðŸ“ˆ Grafik Harga â€” Terhubung ke harga.html (mode B)</div>
        <div class="small-muted">Menampilkan 5 menit ke depan berdasarkan data harga.html â€” geser ke kiri untuk lihat sebelumnya</div>
      </div>
      <div style="text-align:right">
        <div class="small-muted">Sumber data</div>
        <div style="font-weight:700;color:#fff">harga.html / CSV</div>
      </div>
    </div>

    <div id="clockTop" class="clockNowTop">Waktu: --:--:--</div>

    <div class="chart-wrap">
      <canvas id="mainChart"></canvas>
      <div id="clockBottom" class="clockNowBottom">--:--:--</div>
      <div style="margin-top:10px">
        <div class="timeline" id="timeline"></div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Sparkline Hari Ini</div>
          <div style="font-weight:700">Ringkasan Harga</div>
        </div>
        <div>
          <div style="font-size:12px;color:#9aa0a6">Auto-refresh</div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="autoRefresh" checked />
            <small class="muted">on</small>
          </label>
        </div>
      </div>
      <canvas id="sparkline" class="sparkline"></canvas>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btnReload">Reload Data</button>
        <button id="btnCenter">Center Now</button>
      </div>
      <div style="margin-top:10px" class="small-muted">Klik item timeline untuk memilih waktu sebagai referensi.</div>
    </div>

    <div class="card">
      <div class="muted">Detail Terpilih</div>
      <div style="font-size:18px;font-weight:700;margin-top:6px" id="detailTime">--:--:--</div>
      <div style="font-size:16px;margin-top:6px" id="detailPrice">Rp --</div>
    </div>
  </div>
</div>

<script>
// DATA_URL â€” menggunakan file yang Anda upload sebelumnya (lokal di runner)
const DATA_URL = '/mnt/data/jam_harga_format_hh_mm_ss.csv'; // <-- gunakan path file yang sudah ada in repo
let hargaData = []; // {waktu, harga}

async function fetchHargaCSV(){
  const res = await fetch(DATA_URL);
  if(!res.ok) throw new Error('Gagal fetch '+DATA_URL);
  const text = await res.text();
  const lines = text.trim().split('
');
  const rows = lines.slice(1); // skip header
  hargaData = rows.map(r=>{
    const [waktu, harga] = r.split(',');
    return { waktu: waktu.trim(), harga: Number(harga) };
  }).filter(x=>x.waktu);
}

function formatIDR(v){ return 'Rp '+Number(v).toLocaleString('id-ID'); }

// build sparkline
let sparkChart=null, mainChart=null;
function buildSparkline(){
  const ctx = document.getElementById('sparkline').getContext('2d');
  const labels = hargaData.map(d=>d.waktu);
  const data = hargaData.map(d=>d.harga);
  if(sparkChart) sparkChart.destroy();
  sparkChart = new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ data, borderColor:'#f1c40f', pointRadius:0, borderWidth:1 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{tension:0.3}} } });
}

// build main chart from centerIndex showing window of minutes (5 past, current, 5 future)
function buildPerSecondSeries(centerIndex, pastMinutes=5, futureMinutes=5){
  const start = Math.max(0, centerIndex - pastMinutes);
  const end = Math.min(hargaData.length-1, centerIndex + futureMinutes);
  const labels = [];
  const values = [];
  for(let idx=start; idx<=end; idx++){
    const cur = hargaData[idx];
    const next = hargaData[idx+1] || cur;
    for(let s=0;s<60;s++){
      const t = s/60;
      const interp = cur.harga + (next.harga - cur.harga)*t;
      const hhmm = cur.waktu.slice(0,5) + ':' + String(s).padStart(2,'0');
      labels.push(hhmm);
      values.push(+interp.toFixed(3));
    }
  }
  return {labels, values};
}

function createMainChart(labels, values){
  const ctx = document.getElementById('mainChart').getContext('2d');
  if(mainChart) mainChart.destroy();
  mainChart = new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ label:'Harga', data: values, borderColor:'#2ecc71', backgroundColor:'rgba(46,204,113,0.06)', pointRadius:0, borderWidth:2 }] }, options:{ animation:false, responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ ticks:{display:true, maxRotation:0, autoSkip:true, maxTicksLimit:10}, grid:{color:'#111'} }, y:{ ticks:{color:'#9aa0a6'}, grid:{color:'#111'} } } } });
}

function renderTimeline(centerIndex, past=5, future=5){
  const container = document.getElementById('timeline');
  container.innerHTML='';
  const start = Math.max(0, centerIndex - 60); // show a scrollable window of up to 60 prev minutes
  const end = Math.min(hargaData.length-1, centerIndex + 60);
  for(let i=start;i<=end;i++){
    const div = document.createElement('div');
    div.className='time-item';
    if(i>=centerIndex-past && i<=centerIndex+future) div.style.opacity = 1; else div.style.opacity=0.6;
    div.dataset.index = i;
    div.innerHTML = `<div style="font-size:13px">${hargaData[i].waktu.slice(0,5)}</div><div style="font-weight:700;margin-top:6px">${formatIDR(hargaData[i].harga)}</div>`;
    div.addEventListener('click', ()=>{
      document.querySelectorAll('.time-item').forEach(el=>el.classList.remove('active'));
      div.classList.add('active');
      document.getElementById('detailTime').textContent = hargaData[i].waktu;
      document.getElementById('detailPrice').textContent = formatIDR(hargaData[i].harga);
      updateMainForIndex(i);
    });
    container.appendChild(div);
  }
  // scroll timeline to center on centerIndex element
  const activeEl = container.querySelector(`[data-index='${centerIndex}']`);
  if(activeEl) activeEl.scrollIntoView({behavior:'smooth',inline:'center'});
}

function updateMainForIndex(centerIndex){
  const sec = buildPerSecondSeries(centerIndex,5,5);
  createMainChart(sec.labels, sec.values);
}

// clock top and bottom
function startClocks(){
  const top = document.getElementById('clockTop');
  const bottom = document.getElementById('clockBottom');
  setInterval(()=>{
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    top.textContent = `Waktu Sekarang: ${hh}:${mm}:${ss}`;
    bottom.textContent = `${hh}:${mm}:${ss}`;
  },1000);
}

async function init(){
  try{
    await fetchHargaCSV();
    if(!hargaData.length) throw new Error('Data kosong');
    buildSparkline();
    // find current minute index
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const search = `${hh}:${mm}:00`;
    let centerIndex = hargaData.findIndex(d=>d.waktu.startsWith(`${hh}:${mm}`));
    if(centerIndex === -1) centerIndex = Math.max(0, hargaData.length-1);
    renderTimeline(centerIndex,5,5);
    updateMainForIndex(centerIndex);
    document.getElementById('detailTime').textContent = hargaData[centerIndex].waktu;
    document.getElementById('detailPrice').textContent = formatIDR(hargaData[centerIndex].harga);
    startClocks();

    // controls
    document.getElementById('btnReload').addEventListener('click', async ()=>{ await fetchHargaCSV(); buildSparkline(); renderTimeline(centerIndex,5,5); updateMainForIndex(centerIndex); });
    document.getElementById('btnCenter').addEventListener('click', ()=>{ const now2=new Date(); const hh2=String(now2.getHours()).padStart(2,'0'); const mm2=String(now2.getMinutes()).padStart(2,'0'); const idx=hargaData.findIndex(d=>d.waktu.startsWith(`${hh2}:${mm2}`)); if(idx!==-1){ renderTimeline(idx,5,5); updateMainForIndex(idx); } });

    // auto-refresh
    setInterval(async ()=>{
      if(document.getElementById('autoRefresh').checked){
        const prevLen = hargaData.length;
        await fetchHargaCSV();
        if(hargaData.length !== prevLen) buildSparkline();
        // refresh center to current minute
        const now3=new Date(); const hh3=String(now3.getHours()).padStart(2,'0'); const mm3=String(now3.getMinutes()).padStart(2,'0'); const idx3=hargaData.findIndex(d=>d.waktu.startsWith(`${hh3}:${mm3}`)); const cidx = idx3===-1?hargaData.length-1:idx3;
        renderTimeline(cidx,5,5); updateMainForIndex(cidx);
      }
    },30*1000);

  }catch(err){ console.error(err); alert('Error init: '+err.message); }
}

init();
</script>

</body>
</html>
